<div class="container">
    <div class="header">
        <h2>Gerenciar Movimentações</h2>
        <app-button-float appearance="primary" size="l" (click)="openFormModal()">
            Nova Movimentação
        </app-button-float>
    </div>

    @if (periodos().length) {
        <tui-tabs-with-more [(activeItemIndex)]="activeItemIndex" [itemsLimit]="5">
            @for (periodo of periodos(); track periodo) {
                <button *tuiItem tuiTab type="button" (click)="loadMovimentos(periodo)">
                    <tui-badge appearance="neutral" iconStart="@tui.calendar">
                        {{ periodo | formatPeriod }}
                    </tui-badge>
                </button>
            }
        </tui-tabs-with-more>
    }

    @if (!isLoading()) {
        <div class="content">
            <div class="summary">
                <div tuiAppearance="floating" tuiCardLarge tuiCell [tuiHint]="receitasTooltip" tuiHintAppearance="dark" tuiHintDirection="bottom">
                    <tui-avatar appearance="info" src="@tui.banknote-arrow-up" />
                    <div tuiTitle>
                        <strong [class.positive]="true">{{ totalReceitas | currency }}</strong>
                        <div tuiSubtitle>Receitas do mês</div>
                    </div>
                </div>
                <div tuiAppearance="floating" tuiCardLarge tuiCell [tuiHint]="despesasTooltip" tuiHintAppearance="dark" tuiHintDirection="bottom">
                    <tui-avatar appearance="accent" src="@tui.banknote-arrow-down" />
                    <div tuiTitle>
                        <strong [class.negative]="true">{{ totalDespesas * -1 | currency }}</strong>
                        <div tuiSubtitle>Despesas do mês</div>
                    </div>
                </div>
                <div tuiAppearance="floating" tuiCardLarge tuiCell>
                    <tui-avatar [appearance]="saldo >= 0 ? 'positive' : 'negative'" src="@tui.dollar-sign" />
                    <div tuiTitle>
                        <strong [class.negative]="saldo < 0" [class.positive]="saldo >= 0">{{ saldo | currency }}</strong>
                        <div tuiSubtitle>Saldo</div>
                    </div>
                </div>
                @if (hasOrcamento) {
                    <div tuiAppearance="floating" tuiCardLarge tuiCell>
                        <tui-avatar [appearance]="saldoOrcamento >= 0 ? 'positive' : 'negative'" src="@tui.banknote" />
                        <div tuiTitle>
                            <strong [class.negative]="saldoOrcamento < 0" [class.positive]="saldoOrcamento >= 0">{{
                                saldoOrcamento | currency }}</strong>
                            <div tuiSubtitle>Orçamento disponível</div>
                        </div>
                    </div>
                }
            </div>

            <tui-accordion class="accordion" [closeOthers]="false">
                @if (timelineFutureItems().length) {
                    <ng-container>
                        <button
                            appearance=""
                            [tuiAccordion]="showFutureItens()"
                            tuiCell="l"
                            (tuiAccordionChange)="onClickFutureItens()"
                        >
                            <span tuiTitle>
                                <strong>Lançamentos Futuros</strong>
                                <span tuiSubtitle>
                                    <tui-badge iconStart="@tui.banknote-arrow-up" appearance="info" size="s">
                                        {{ somaValores(timelineFutureItems(), CATEGORIA_TIPO.RECEITA) | currency }}
                                    </tui-badge>
                                    <tui-badge iconStart="@tui.banknote-arrow-down" appearance="negative" size="s">
                                        {{ somaValores(timelineFutureItems(), CATEGORIA_TIPO.DESPESA) | currency }}
                                    </tui-badge>
                                </span>
                            </span>
                        </button>
                        <tui-expand [expanded]="showFutureItens()">
                            <ng-container *ngTemplateOutlet="timelineFutureItemsTemplate"></ng-container>
                        </tui-expand>
                    </ng-container>
                }
                @if (timelineTodayItems().length) {
                    <ng-container>
                        <button
                            appearance=""
                            [tuiAccordion]="showTodayItens()"
                            tuiCell="l"
                            (tuiAccordionChange)="onClickTodayItens()"
                        >
                            <span tuiTitle>
                                <strong>Hoje</strong>
                                <span tuiSubtitle>
                                    <tui-badge iconStart="@tui.banknote-arrow-up" appearance="info" size="s">
                                        {{ somaValores(timelineTodayItems(), CATEGORIA_TIPO.RECEITA) | currency }}
                                    </tui-badge>
                                    <tui-badge iconStart="@tui.banknote-arrow-down" appearance="negative" size="s">
                                        {{ somaValores(timelineTodayItems(), CATEGORIA_TIPO.DESPESA) | currency }}
                                    </tui-badge>
                                </span>
                            </span>
                        </button>
                        <tui-expand [expanded]="showTodayItens()">
                            <ng-container *ngTemplateOutlet="timelineTodayItemsTemplate"></ng-container>
                        </tui-expand>
                    </ng-container>
                }
                @if (timelinePastItems().length && (timelineFutureItems().length || timelineTodayItems().length)) {
                    <ng-container>
                        <button
                            appearance=""
                            [tuiAccordion]="showPastItens()"
                            tuiCell="l"
                            (tuiAccordionChange)="onClickPastItens()"
                        >
                            <span tuiTitle>
                                <strong>Dias anteriores</strong>
                                <span tuiSubtitle>
                                    <tui-badge iconStart="@tui.banknote-arrow-up" appearance="info" size="s">
                                        {{ somaValores(timelinePastItems(), CATEGORIA_TIPO.RECEITA) | currency }}
                                    </tui-badge>
                                    <tui-badge iconStart="@tui.banknote-arrow-down" appearance="negative" size="s">
                                        {{ somaValores(timelinePastItems(), CATEGORIA_TIPO.DESPESA) | currency }}
                                    </tui-badge>
                                </span>
                            </span>
                        </button>
                        <tui-expand [expanded]="showPastItens()">
                            <ng-container *ngTemplateOutlet="timelinePastItemsTemplate"></ng-container>
                        </tui-expand>
                    </ng-container>
                }
            </tui-accordion>

            @if (!timelineFutureItems().length && !timelineTodayItems().length) {
                <ng-container *ngTemplateOutlet="timelinePastItemsTemplate"></ng-container>
            }
        </div>
    }

    @if (isLoading()) {
        <div class="loading">
            <p>Carregando movimentações...</p>
        </div>
    }
</div>

<ng-template #timelinePastItemsTemplate>
    <div class="timeline-container" tuiCell="l">
        <app-timeline
            [items]="timelinePastItems()"
            (edit)="openFormModal($event)"
            (delete)="confirmDelete($event)"
            (duplicate)="duplicateItem($event)">
        </app-timeline>
    </div> 
</ng-template>

<ng-template #timelineTodayItemsTemplate>
    <div class="timeline-container" tuiCell="l">
        <app-timeline
            [items]="timelineTodayItems()"
            (edit)="openFormModal($event)"
            (delete)="confirmDelete($event)"
            (duplicate)="duplicateItem($event)">
        </app-timeline>
    </div>
</ng-template>

<ng-template #timelineFutureItemsTemplate>
    <div class="timeline-container" tuiCell="l">
        <app-timeline
            [items]="timelineFutureItems()"
            (edit)="openFormModal($event)"
            (delete)="confirmDelete($event)"
            (duplicate)="duplicateItem($event)">
        </app-timeline>
    </div>
</ng-template>

<ng-template #receitasTooltip>
    <div tuiTitle>
        <strong>{{ totalOrcamentoReceita | currency }}</strong>
        <div tuiSubtitle>Total de receitas esperadas para o mês</div>
    </div>
</ng-template>

<ng-template #despesasTooltip>
    <div tuiTitle>
        <strong>{{ totalOrcamentoDespesa * -1 | currency }}</strong>
        <div tuiSubtitle>Total de despesas esperadas para o mês</div>
    </div>
</ng-template>
